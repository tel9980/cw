{% extends "base.html" %}

{% block title %}报表看板 - 氧化加工厂财务系统{% endblock %}

{% block content %}
<div class="card">
  <h2>报表看板</h2>
  <div style="display:flex; flex-wrap:wrap; gap:20px;">
    <div style="flex:1 1 300px; min-width:300px;">
      <h3>汇总</h3>
      <ul style="list-style:none; padding:0; margin:0;">
        <li>总收入: {{ data.summary.total_income }}</li>
        <li>总支出: {{ data.summary.total_expense }}</li>
        <li>订单数量: {{ data.summary.order_count }}</li>
        <li>利润: {{ data.summary.profit }}</li>
      </ul>
    </div>
    <div style="flex:1 1 300px; min-width:300px;">
      <h3>本月利润趋势</h3>
      {% if data.monthly %}
      <div style="width:100%; overflow:auto;">
        <svg viewBox="0 0 {{ data.monthly|length * 40 + 20 }} 180" width="100%" height="180" aria-label="Monthly Profit Chart">
          {% set max_p = data.monthly[0].profit %}
          {% if max_p is not defined %}{% set max_p = 1 %}{% endif %}
          {% for m in data.monthly %}
          {% set idx = loop.index0 %}
          {% set bar_w = 28 %}
          {% set gap = 12 %}
          {% set h = (m.profit / max_p) * 140 if max_p > 0 else 0 %}
          <rect x="{{ 20 + idx * (bar_w + gap) }}" y="{{ 140 - h|int }}" width="{{ bar_w }}" height="{{ h|int }}" fill="#3b82f6" />
          <text x="{{ 20 + idx * (bar_w + gap) + bar_w/2 }}" y="170" text-anchor="middle" font-size="11" fill="#333">{{ m.month[-2:] }}</text>
          {% endfor %}
        </svg>
      </div>
      {% else %}
      <div>无数据</div>
      {% endif %}
    </div>
  </div>
</div>

<div class="card">
  <h3>Top 客户</h3>
  <table>
    <thead><tr><th>名称</th><th>订单数</th><th>总额</th></tr></thead>
    <tbody>
      {% for c in data.top_customers %}
      <tr><td>{{ c.name }}</td><td>{{ c.order_count }}</td><td>{{ c.total }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h3>支出类型</h3>
  <table>
    <thead><tr><th>类型</th><th>总额</th></tr></thead>
    <tbody>
      {% for e in data.expense_by_type %}
      <tr><td>{{ e.expense_type }}</td><td>{{ e.total }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
