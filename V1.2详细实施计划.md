# V1.2 版本详细实施计划

## 📅 版本信息
- **版本号：** V1.2
- **开发周期：** 5-7天
- **目标完成度：** 55%（从45%提升）
- **核心目标：** 完善订单管理功能

---

## 🎯 功能清单

### 1. 订单编辑功能 ⭐⭐⭐⭐⭐

#### 1.1 需求分析
**用户场景：**
- 小白会计录入订单时输错了客户名称，需要修改
- 订单数量变更，需要更新数量和金额
- 外发成本发生变化，需要调整
- 订单状态需要更新（待生产→生产中→已完工→已结算）

**功能需求：**
- 支持修改所有订单字段
- 自动重新计算金额
- 记录修改历史
- 修改前确认

#### 1.2 技术设计

**数据结构（修改历史）：**
```python
{
    "history_id": "HIST001",
    "order_no": "ORD001",
    "modified_at": "2026-02-10 14:30:00",
    "modified_by": "系统用户",
    "changes": {
        "customer": {"old": "华强五金", "new": "华强五金厂"},
        "quantity": {"old": 100, "new": 120},
        "order_amount": {"old": 250.00, "new": 300.00}
    }
}
```

**核心函数：**
```python
def update_order(order_no: str, updates: dict) -> bool:
    """
    更新订单
    
    Args:
        order_no: 订单编号
        updates: 更新字段字典
    
    Returns:
        bool: 是否更新成功
    """
    # 1. 获取原订单
    # 2. 验证更新数据
    # 3. 记录修改历史
    # 4. 更新订单
    # 5. 重新计算金额
    # 6. 保存订单
```

#### 1.3 界面设计

**编辑订单菜单：**
```
═══════════════════════════════════════════════════════════════════
     编辑订单 - ORD001
═══════════════════════════════════════════════════════════════════

当前信息：
  1. 订单编号: ORD001
  2. 客户名称: 华强五金
  3. 订单日期: 2026-02-09
  4. 物品名称: 铝合金把手
  5. 计价单位: 件
  6. 数量: 100
  7. 单价: 2.5 元
  8. 订单金额: 250.00 元
  9. 工序明细: 氧化
 10. 外发工序: 喷砂
 11. 外发成本: 50.00 元
 12. 订单状态: 待生产
 13. 备注: 

请选择要修改的字段（输入编号，0返回）：
```

**修改确认：**
```
═══════════════════════════════════════════════════════════════════
     确认修改
═══════════════════════════════════════════════════════════════════

修改内容：
  客户名称: 华强五金 → 华强五金厂
  数量: 100 → 120
  订单金额: 250.00 → 300.00 元

是否确认修改？(y/n): 
```

#### 1.4 实施步骤

**Day 1：**
1. 在 `local_storage.py` 添加 `update_order()` 方法
2. 实现修改历史记录功能
3. 编写单元测试

**Day 2：**
1. 在主程序添加"编辑订单"菜单项
2. 实现订单选择界面
3. 实现字段编辑界面
4. 实现修改确认界面
5. 集成测试

---

### 2. 订单删除功能 ⭐⭐⭐⭐

#### 2.1 需求分析
**用户场景：**
- 误创建的订单需要删除
- 测试订单需要清理
- 作废订单需要删除

**功能需求：**
- 支持单个删除
- 支持批量删除
- 删除前确认
- 支持软删除（可恢复）

#### 2.2 技术设计

**软删除实现：**
```python
{
    "order_no": "ORD001",
    "deleted": true,
    "deleted_at": "2026-02-10 15:00:00",
    "deleted_by": "系统用户",
    ...
}
```

**核心函数：**
```python
def delete_order(order_no: str, soft_delete: bool = True) -> bool:
    """
    删除订单
    
    Args:
        order_no: 订单编号
        soft_delete: 是否软删除
    
    Returns:
        bool: 是否删除成功
    """
```

#### 2.3 界面设计

**删除确认：**
```
═══════════════════════════════════════════════════════════════════
     删除订单
═══════════════════════════════════════════════════════════════════

订单信息：
  订单编号: ORD001
  客户名称: 华强五金
  订单金额: 250.00 元
  订单状态: 待生产

⚠️  警告：删除后可以恢复，但建议谨慎操作！

是否确认删除？(y/n): 
```

#### 2.4 实施步骤

**Day 1：**
1. 完善 `delete_order()` 方法
2. 实现软删除功能
3. 实现恢复功能
4. 编写单元测试
5. 在主程序添加删除菜单
6. 集成测试

---

### 3. 收款记录功能 ⭐⭐⭐⭐⭐

#### 3.1 需求分析
**用户场景：**
- 客户付款后需要记录
- 查看某个订单的收款历史
- 查看某个客户的收款记录
- 生成收款统计报表

**功能需求：**
- 记录每笔收款
- 关联订单
- 自动更新已收款金额
- 支持部分收款
- 支持合并收款
- 生成收款记录表

#### 3.2 技术设计

**数据结构：**
```python
{
    "payment_id": "PAY001",
    "payment_date": "2026-02-10",
    "customer": "华强五金",
    "amount": 1000.00,
    "payment_method": "银行转账",
    "bank_account": "G银行",
    "related_orders": ["ORD001"],
    "remark": "部分收款",
    "created_at": "2026-02-10 16:00:00"
}
```

**核心函数：**
```python
def record_payment(payment_data: dict) -> bool:
    """记录收款"""
    
def get_payment_history(order_no: str = None, customer: str = None) -> list:
    """获取收款历史"""
    
def get_payment_statistics(date_from: str = None, date_to: str = None) -> dict:
    """获取收款统计"""
```

#### 3.3 界面设计

**收款录入：**
```
═══════════════════════════════════════════════════════════════════
     记录收款
═══════════════════════════════════════════════════════════════════

步骤1：选择订单
  请输入订单编号（或客户名称搜索）: ORD001

订单信息：
  订单编号: ORD001
  客户名称: 华强五金
  订单金额: 2500.00 元
  已收款: 0.00 元
  未收款: 2500.00 元

步骤2：输入收款信息
  收款金额: 1000.00
  收款日期 (YYYY-MM-DD): 2026-02-10
  收款方式 (银行转账/现金/微信/支付宝): 银行转账
  银行账户 (G银行/N银行/微信): G银行
  备注: 部分收款

步骤3：确认收款
  订单编号: ORD001
  客户名称: 华强五金
  收款金额: 1000.00 元
  收款方式: 银行转账
  
  更新后：
  已收款: 1000.00 元
  未收款: 1500.00 元

是否确认？(y/n): 
```

**收款历史：**
```
═══════════════════════════════════════════════════════════════════
     收款历史 - ORD001
═══════════════════════════════════════════════════════════════════

订单信息：
  订单编号: ORD001
  客户名称: 华强五金
  订单金额: 2500.00 元
  已收款: 1500.00 元
  未收款: 1000.00 元

收款记录：
  1. 2026-02-10  1000.00元  银行转账  G银行  部分收款
  2. 2026-02-15   500.00元  现金      -      部分收款

共2笔收款，合计 1500.00 元
```

#### 3.4 实施步骤

**Day 1：**
1. 创建 `payment_manager.py` 模块
2. 定义收款记录数据模型
3. 实现收款记录功能
4. 编写单元测试

**Day 2：**
1. 在主程序添加"记录收款"菜单项
2. 实现收款录入界面
3. 实现收款历史查询
4. 实现收款统计功能
5. 集成测试

---

### 4. 批量操作功能 ⭐⭐⭐

#### 4.1 需求分析
**用户场景：**
- 批量修改订单状态（生产中→已完工）
- 批量导出选定订单
- 批量删除测试订单

**功能需求：**
- 订单多选
- 批量状态更新
- 批量导出
- 批量删除

#### 4.2 技术设计

**核心函数：**
```python
def batch_update_status(order_nos: list, new_status: str) -> dict:
    """批量更新状态"""
    
def batch_export(order_nos: list, output_file: str) -> bool:
    """批量导出"""
    
def batch_delete(order_nos: list) -> dict:
    """批量删除"""
```

#### 4.3 界面设计

**批量操作菜单：**
```
═══════════════════════════════════════════════════════════════════
     批量操作
═══════════════════════════════════════════════════════════════════

当前已选择 5 个订单：
  1. ORD001 - 华强五金 - 2500.00元
  2. ORD002 - 精工制造 - 3600.00元
  3. ORD003 - 建筑五金 - 3000.00元
  4. ORD004 - 装饰材料 - 4000.00元
  5. ORD005 - 五金加工 - 2000.00元

批量操作：
  1. 批量修改状态
  2. 批量导出Excel
  3. 批量删除
  0. 返回

请选择操作：
```

#### 4.4 实施步骤

**Day 1：**
1. 实现订单多选功能
2. 实现批量状态更新
3. 实现批量导出
4. 实现批量删除
5. 在主程序添加批量操作菜单
6. 集成测试

---

## 📅 开发时间表

### 第1天（周一）
- [ ] 实现订单编辑功能（后端）
- [ ] 编写单元测试

### 第2天（周二）
- [ ] 实现订单编辑功能（前端）
- [ ] 集成测试

### 第3天（周三）
- [ ] 实现订单删除功能
- [ ] 编写单元测试

### 第4天（周四）
- [ ] 实现收款记录功能（后端）
- [ ] 编写单元测试

### 第5天（周五）
- [ ] 实现收款记录功能（前端）
- [ ] 集成测试

### 第6天（周六）
- [ ] 实现批量操作功能
- [ ] 全面测试

### 第7天（周日）
- [ ] Bug修复
- [ ] 文档更新
- [ ] 发布V1.2版本

---

## ✅ 验收标准

### 功能验收
- [ ] 订单编辑功能正常
- [ ] 订单删除功能正常
- [ ] 收款记录功能正常
- [ ] 批量操作功能正常
- [ ] 所有测试用例通过

### 性能验收
- [ ] 订单编辑响应 < 1秒
- [ ] 批量操作响应 < 3秒
- [ ] 无内存泄漏

### 用户体验验收
- [ ] 界面友好
- [ ] 操作流畅
- [ ] 错误提示清晰
- [ ] 帮助文档完整

---

## 📝 测试计划

### 单元测试
```python
# test_order_edit.py
def test_update_order():
    """测试订单更新"""
    
def test_update_order_with_invalid_data():
    """测试无效数据更新"""
    
def test_update_order_history():
    """测试修改历史记录"""

# test_order_delete.py
def test_delete_order():
    """测试订单删除"""
    
def test_soft_delete():
    """测试软删除"""
    
def test_restore_order():
    """测试恢复订单"""

# test_payment.py
def test_record_payment():
    """测试记录收款"""
    
def test_payment_history():
    """测试收款历史"""
    
def test_payment_statistics():
    """测试收款统计"""
```

### 集成测试
1. 创建订单 → 编辑订单 → 记录收款 → 查看统计
2. 创建订单 → 删除订单 → 恢复订单
3. 创建多个订单 → 批量操作

### 用户验收测试
1. 小白会计操作测试
2. 典型业务场景测试
3. 异常情况测试

---

## 📚 文档更新

### 需要更新的文档
1. `优化说明.txt` - 添加V1.2说明
2. `快速使用指南.txt` - 添加新功能说明
3. `V1.2发布说明.md` - 创建发布说明
4. `PROGRESS.md` - 更新开发进度

---

## 🚀 发布计划

### 发布前检查
- [ ] 所有功能测试通过
- [ ] 文档更新完成
- [ ] 示例数据更新
- [ ] 版本号更新

### 发布步骤
1. 更新版本号（V1.1 → V1.2）
2. 创建Git标签
3. 推送到GitHub
4. 创建Release
5. 发布公告

---

**计划制定日期：** 2026-02-09  
**预计开始日期：** 2026-02-10  
**预计完成日期：** 2026-02-16
