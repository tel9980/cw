# -*- coding: utf-8 -*-
"""
å°å‹æ°§åŒ–åŠ å·¥å‚ - è´¢åŠ¡æ•°æ®æ¨¡æ‹Ÿç”Ÿæˆå™¨
åŠŸèƒ½ï¼š
1. æ›´æ–° category_rules.json é€‚é…å·¥å‚åœºæ™¯
2. ç”Ÿæˆ Gé“¶è¡Œï¼ˆå¯¹å…¬ï¼‰æµæ°´ Excel
3. ç”Ÿæˆ Né“¶è¡Œ/å¾®ä¿¡ï¼ˆç°é‡‘ï¼‰æµæ°´ Excel
"""
import os
import json
import pandas as pd
import random
from datetime import datetime, timedelta

# 1. è·¯å¾„é…ç½®
ROOT_DIR = os.path.dirname(os.path.abspath(__file__))
DATA_ROOT = os.path.join(ROOT_DIR, "è´¢åŠ¡æ•°æ®")
PENDING_DIR = os.path.join(DATA_ROOT, "å¾…å¤„ç†å•æ®")
CONFIG_DIR = os.path.join(DATA_ROOT, "é…ç½®æ–‡ä»¶")
FILE_CATEGORY_RULES = os.path.join(CONFIG_DIR, "category_rules.json")

# ç¡®ä¿ç›®å½•å­˜åœ¨
for d in [PENDING_DIR, CONFIG_DIR]:
    os.makedirs(d, exist_ok=True)

# 2. æ›´æ–°åˆ†ç±»è§„åˆ™
def update_rules():
    new_rules = {
        # åŸææ–™ - åŒ–å·¥è¾…æ–™
        "ä¸‰é…¸": "åŸææ–™-åŒ–å·¥è¾…æ–™",
        "ç¡«é…¸": "åŸææ–™-åŒ–å·¥è¾…æ–™",
        "ç¡é…¸": "åŸææ–™-åŒ–å·¥è¾…æ–™",
        "ç£·é…¸": "åŸææ–™-åŒ–å·¥è¾…æ–™",
        "ç‰‡ç¢±": "åŸææ–™-åŒ–å·¥è¾…æ–™",
        "äºšé’ ": "åŸææ–™-åŒ–å·¥è¾…æ–™",
        "è‰²ç²‰": "åŸææ–™-åŒ–å·¥è¾…æ–™",
        "é™¤æ²¹å‰‚": "åŸææ–™-åŒ–å·¥è¾…æ–™",
        "å°å­”å‰‚": "åŸææ–™-åŒ–å·¥è¾…æ–™",
        "å…‰äº®å‰‚": "åŸææ–™-åŒ–å·¥è¾…æ–™",
        
        # åŸææ–™ - æŒ‚å…·
        "æŒ‚å…·": "åŸææ–™-å‘¨è½¬ææ–™",
        "é’›æŒ‚å…·": "åŸææ–™-å‘¨è½¬ææ–™",
        
        # å¤–ååŠ å·¥
        "å–·ç ‚": "å¤–ååŠ å·¥è´¹",
        "æ‹‰ä¸": "å¤–ååŠ å·¥è´¹",
        "æŠ›å…‰": "å¤–ååŠ å·¥è´¹",
        "å§”å¤–": "å¤–ååŠ å·¥è´¹",
        
        # æ”¶å…¥
        "æ°§åŒ–åŠ å·¥è´¹": "ä¸»è¥ä¸šåŠ¡æ”¶å…¥",
        "æ¥æ–™åŠ å·¥": "ä¸»è¥ä¸šåŠ¡æ”¶å…¥",
        "åŠ å·¥è´¹æ”¶å…¥": "ä¸»è¥ä¸šåŠ¡æ”¶å…¥",
        
        # åŸºç¡€è´¹ç”¨
        "æˆ¿ç§Ÿ": "æˆ¿ç§Ÿç‰©ä¸šè´¹",
        "æ°´è´¹": "æ°´ç”µè´¹",
        "ç”µè´¹": "æ°´ç”µè´¹",
        "å·¥èµ„": "å·¥èµ„è–ªé‡‘",
        "ä¼™é£Ÿ": "ç¦åˆ©è´¹-é¤è´¹",
        "åƒåœ¾": "å«ç”Ÿè´¹",
        "ç»´ä¿®": "ç»´ä¿®è´¹"
    }
    
    # è¯»å–ç°æœ‰è§„åˆ™æˆ–åˆ›å»ºæ–°è§„åˆ™
    current_rules = {}
    if os.path.exists(FILE_CATEGORY_RULES):
        try:
            with open(FILE_CATEGORY_RULES, "r", encoding="utf-8") as f:
                current_rules = json.load(f)
        except: pass
        
    # åˆå¹¶è§„åˆ™
    current_rules.update(new_rules)
    
    # ä¿å­˜
    with open(FILE_CATEGORY_RULES, "w", encoding="utf-8") as f:
        json.dump(current_rules, f, ensure_ascii=False, indent=4)
    print(f"âœ… å·²æ›´æ–°åˆ†ç±»è§„åˆ™åº“ï¼Œæ–°å¢/æ›´æ–°äº† {len(new_rules)} æ¡å·¥å‚ä¸“ç”¨è§„åˆ™")

# 3. ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
def generate_excel():
    # æ—¥æœŸèŒƒå›´ï¼šæœ¬æœˆ
    now = datetime.now()
    year = now.year
    month = now.month
    
    # === Gé“¶è¡Œ (å¯¹å…¬) ===
    # ç‰¹ç‚¹ï¼šå¤§é¢ã€æœ‰ç¥¨ã€åŸææ–™é‡‡è´­ã€æ”¶åŠ å·¥è´¹
    g_bank_data = []
    
    # æ”¶å…¥ (å®¢æˆ·ä»˜æ¬¾ï¼Œé€šå¸¸ä¸æ˜¯ä¸€ä¸€å¯¹åº”ï¼Œæ˜¯å‡‘æ•´ä»˜)
    customers = ["Aç¯é¥°å‚", "Bäº”é‡‘åˆ¶å“", "Cç”µå­ç§‘æŠ€", "Dé“ä¸š"]
    for _ in range(5):
        day = random.randint(1, 28)
        cust = random.choice(customers)
        amt = random.randint(10, 100) * 1000 # 1ä¸‡åˆ°10ä¸‡
        g_bank_data.append({
            "è®°è´¦æ—¥æœŸ": f"{year}-{month:02d}-{day:02d}",
            "äº¤æ˜“é“¶è¡Œ": "Gé“¶è¡Œ",
            "æ‘˜è¦": f"æ”¶{cust}æ°§åŒ–åŠ å·¥è´¹",
            "å¯¹æ–¹æˆ·å": cust,
            "æ”¶å…¥é‡‘é¢": amt,
            "æ”¯å‡ºé‡‘é¢": 0,
            "å¤‡æ³¨": "å¤šç¬”è®¢å•åˆå¹¶ä»˜æ¬¾"
        })
        
    # æ”¯å‡º (åŸææ–™é‡‡è´­)
    suppliers = [
        ("å…´è¾¾åŒ–å·¥", "è´­ä¹°ä¸‰é…¸ã€ç‰‡ç¢±", 20000),
        ("å¼ºåŠ›æŒ‚å…·å‚", "å®šåˆ¶é’›æŒ‚å…·ä¸€æ‰¹", 5000),
        ("æ–°ææ–™ç§‘æŠ€", "è´­ä¹°é™¤æ²¹å‰‚ã€è‰²ç²‰", 8000),
        ("å›­åŒºç‰©ä¸š", "æ”¯ä»˜æœ¬æœˆæˆ¿ç§Ÿæ°´ç”µ", 35000),
        ("ç²¾è‰ºæŠ›å…‰å‚", "æ”¯ä»˜å¤–å‘æŠ›å…‰è´¹", 6000)
    ]
    for supp, memo, base_amt in suppliers:
        day = random.randint(1, 28)
        amt = base_amt + random.randint(-500, 500)
        g_bank_data.append({
            "è®°è´¦æ—¥æœŸ": f"{year}-{month:02d}-{day:02d}",
            "äº¤æ˜“é“¶è¡Œ": "Gé“¶è¡Œ",
            "æ‘˜è¦": memo,
            "å¯¹æ–¹æˆ·å": supp,
            "æ”¶å…¥é‡‘é¢": 0,
            "æ”¯å‡ºé‡‘é¢": amt,
            "å¤‡æ³¨": "æœ‰ç¥¨"
        })

    # === Né“¶è¡Œ/å¾®ä¿¡ (ç°é‡‘) ===
    # ç‰¹ç‚¹ï¼šå°é¢ã€æ— ç¥¨ã€å·¥èµ„ã€æ—¥å¸¸æ‚è´¹
    n_bank_data = []
    
    # æ”¯å‡º (æ—¥å¸¸)
    expenses = [
        ("äº”é‡‘åº—", "è´­ä¹°èºä¸ã€èƒ¶å¸¦", 200),
        ("å¿«é¤åº—", "å‘˜å·¥åŠ ç­é¤è´¹", 300),
        ("åºŸå“ç«™", "æ¸…ç†åƒåœ¾è´¹", 500),
        ("ç»´ä¿®éƒ¨", "ç»´ä¿®æ•´æµæœº", 1200),
        ("å¼ ä¸‰", "æ”¯ä»˜å¼ ä¸‰å·¥èµ„", 6000),
        ("æå››", "æ”¯ä»˜æå››å·¥èµ„", 5500)
    ]
    for payee, memo, base_amt in expenses:
        day = random.randint(1, 28)
        amt = base_amt + random.randint(-50, 50)
        n_bank_data.append({
            "è®°è´¦æ—¥æœŸ": f"{year}-{month:02d}-{day:02d}",
            "äº¤æ˜“é“¶è¡Œ": "å¾®ä¿¡",
            "æ‘˜è¦": memo,
            "å¯¹æ–¹æˆ·å": payee,
            "æ”¶å…¥é‡‘é¢": 0,
            "æ”¯å‡ºé‡‘é¢": amt,
            "å¤‡æ³¨": "æ— ç¥¨"
        })
        
    # æ”¶å…¥ (å°‘é‡ç°é‡‘æ”¶æ¬¾)
    for _ in range(3):
        day = random.randint(1, 28)
        amt = random.randint(1, 20) * 100
        n_bank_data.append({
            "è®°è´¦æ—¥æœŸ": f"{year}-{month:02d}-{day:02d}",
            "äº¤æ˜“é“¶è¡Œ": "å¾®ä¿¡",
            "æ‘˜è¦": "æ”¶æ•£å®¢æ°§åŒ–è´¹",
            "å¯¹æ–¹æˆ·å": "æ•£å®¢",
            "æ”¶å…¥é‡‘é¢": amt,
            "æ”¯å‡ºé‡‘é¢": 0,
            "å¤‡æ³¨": "æ— ç¥¨"
        })

    # ä¿å­˜æ–‡ä»¶
    df_g = pd.DataFrame(g_bank_data)
    # è®¡ç®—å®é™…æ”¶ä»˜é‡‘é¢ (æ­£æ•°ä¸ºæ”¶ï¼Œè´Ÿæ•°ä¸ºæ”¯)
    df_g["å®é™…æ”¶ä»˜é‡‘é¢"] = df_g["æ”¶å…¥é‡‘é¢"] - df_g["æ”¯å‡ºé‡‘é¢"]
    file_g = os.path.join(PENDING_DIR, f"æ¨¡æ‹Ÿ_Gé“¶è¡Œ_å¯¹å…¬æµæ°´_{year}{month}.xlsx")
    df_g.to_excel(file_g, index=False)
    print(f"âœ… å·²ç”Ÿæˆ Gé“¶è¡Œæµæ°´: {file_g}")

    df_n = pd.DataFrame(n_bank_data)
    df_n["å®é™…æ”¶ä»˜é‡‘é¢"] = df_n["æ”¶å…¥é‡‘é¢"] - df_n["æ”¯å‡ºé‡‘é¢"]
    file_n = os.path.join(PENDING_DIR, f"æ¨¡æ‹Ÿ_Né“¶è¡Œ_å¾®ä¿¡æµæ°´_{year}{month}.xlsx")
    df_n.to_excel(file_n, index=False)
    print(f"âœ… å·²ç”Ÿæˆ Né“¶è¡Œ/å¾®ä¿¡æµæ°´: {file_n}")

if __name__ == "__main__":
    print("ğŸ­ æ­£åœ¨åˆå§‹åŒ–æ°§åŒ–å‚è´¢åŠ¡æ¨¡æ‹Ÿç¯å¢ƒ...")
    update_rules()
    generate_excel()
    print("\nğŸ‰ æ¨¡æ‹Ÿå®Œæˆï¼")
    print("ğŸ‘‰ è¯·è¿è¡Œ 'run.bat' æˆ– 'CW.py'ï¼Œç„¶åè¾“å…¥ '00' (ä¸€é”®æ—¥ç»“) æ¥ä½“éªŒè‡ªåŠ¨åŒ–å¤„ç†æ•ˆæœã€‚")
    print("ğŸ‘‰ è§‚å¯Ÿ 'è´¢åŠ¡æ•°æ®/å·²å¤„ç†å½’æ¡£' å’Œç”Ÿæˆçš„ 'HTMLæ—¥æŠ¥'ã€‚")
